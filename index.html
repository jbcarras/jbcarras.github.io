<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="static/css/editor.css">
    <link rel="stylesheet" id="dark-mode-style" href="static/css/dark.css" disabled>
    <link rel="shortcut icon" href="static/favicon.ico">
    <title>Level Editor</title>
</head>
<body>
    <div id="editor">
            <div id="level-container">
                <div id="level"></div>
            </div>
            <div id="secondary-container">
                <div id="settings">
                    <h2>Settings</h2>
                    <label for="name">Level Name</label>
                    <input id="name" name="name" type="text">
                    <br/>
                    <label for="width">Width</label>
                    <input id="width" name="width" type="number" value="12" min="0" size="3" oninput="this.value = Math.max(this.value, 0)">
                    <label for="height">Height</label>
                    <input id="height" name="height" type="number" value="8" min="0" size="3" oninput="this.value = Math.max(this.value, 0)">
                    <br/>
                    <button id="export">Export Level</button>
                    <button id="reset">Reset Level</button>
                    <br/>
                    <label for="dark-mode">Dark Mode</label>
                    <input id="dark-mode" name="dark-mode" type="checkbox" onclick="setDarkMode(this.checked)">
                </div>
                <hr/>
                <div id="attributes-section">

                </div>
                <br/>
                <hr/>
                <div id="toolbar-settings">
                    <label for="task">Progress</label>
                    <select id="task" name="task">
                        <option value="1">Task 1</option>
                        <option value="2">Task 2</option>
                        <option value="3">Task 3</option>
                        <option value="4">Task 4</option>
                        <option value="5">Task 5</option>
                        <option value="6" selected>Task 6</option>
                    </select>
                    <br/>
                    <label for="type">Level Type</label>
                    <select id="type" name="type">
                        <option value="topdown" selected>TopDownLevel</option>
                        <option value="platformer">PlatformerLevel</option>
                    </select>
                </div>
                <div id="toolbar"></div>
                <hr/>
            </div>
    </div>
</body>

<script>

    class Attribute {
        constructor(name, defaultVal, inputType) {
            this.name = name
            this.defaultVal = defaultVal
            this.inputType = inputType
        }
    }

    class Item {
        constructor(name, description, parent, attributes, url, task, allowedTypes) {
            this.name = name
            this.description = description
            this.parent = parent
            this.attributes = attributes
            this.url = url
            this.task = task
            this.allowedTypes = allowedTypes
        }
    }

    const items = {
        "Wall": new Item("Wall", "A wall for top-down levels.", "StaticGameObject", [], "static/tiles/Wall.png", 1, ["topdown"]),
        "PlatformerWall": new Item("PlatformerWall", "A wall for platformer levels. Accounts for gravity.", "StaticGameObject", [], "static/tiles/PlatformerWall.png", 3, ["platformer"]),
        "Player": new Item("Player", "Where the player appears when the level is loaded.", "n/a", [], "static/tiles/Player.png", 1, ["topdown", "platformer"]),
        "Demon": new Item("Demon", "Harms the player. May be able to move.", "DynamicGameObject", [new Attribute("MaxHP", 10, "number"), new Attribute("Strength", 3, "number")], "static/tiles/Enemy.png", 1, ["topdown"]),
        "AxePickup": new Item("AxePickup", "A slow-moving but strong projectile.", "StaticGameObject", [], "static/tiles/Axe.png", 5, ["topdown"]),
        "Goal": new Item("Goal", "Calls advanceLevel() when a Player collides.", "StaticGameObject", [], "static/tiles/Goal.png", 1, ["topdown", "platformer"]),
        "Potion": new Item("Potion", "A potion that heals Players who come in contact.", "StaticGameObject", [new Attribute("Heal", 10, "number")], "static/tiles/RedPotion.png", 3, ["topdown", "platformer"]),
        "PotionPickup": new Item("PotionPickup", "A potion that gets stored in a Player's inventory to be consumed later.", "StaticGameObject", [new Attribute("Heal", 10, "number")], "static/tiles/BluePotion.png", 5, ["topdown", "platformer"]),
        "Tower": new Item("Tower", "Indestructible immobile enemy tower.", "DynamicGameObject", [], "static/tiles/Tower.png')}}", 1, ["topdown"]),
        "MagicPickup": new Item("MagicPickup", "A fast but weaker projectile.", "StaticGameObject", [], "static/tiles/Magic.png", 5, ["topdown"]),
        "Spike": new Item("Spike", "A fatal obstacle.", "StaticGameObject", [], "static/tiles/Spike.png", 3, ["topdown", "platformer"]),
        "SmartEnemy": new Item("SmartEnemy", "A smarter enemy that hunts the player down, avoiding walls.", "DynamicGameObject", [new Attribute("MaxHP", 10, "number"), new Attribute("Strength", 1, "number")], "static/tiles/SmartEnemy.png", 6, ["topdown"])
    }

    const selector = "static/tiles/Selector.png')}}"

    let board = []

    let activeItem = "Wall"
    let task = 6
    let type = "topdown"

    let toolbar = document.getElementById("toolbar")
    let level = document.getElementById("level")

    const reset = document.getElementById("reset")
    reset.addEventListener("click", resetLevel)

    const exportBtn = document.getElementById("export")
    exportBtn.addEventListener("click", exportLevel)

    const taskSelect = document.getElementById("task")
    taskSelect.addEventListener("change", () => {
        task = Number(taskSelect.value)
        renderToolbar()
    })

    const typeSelect = document.getElementById("type")
    typeSelect.addEventListener("change", () => {
        type = typeSelect.value
        renderToolbar()
        setActiveItemTo(Array.from(document.getElementById("toolbar").children).includes(activeItem) ? activeItem : document.getElementById("toolbar").children[0])
    })

    type = typeSelect.value
    task = Number(taskSelect.value)

    resetLevel()
    renderAttributes()
    renderToolbar()
    setActiveItemTo(toolbar.children[0])

    if (localStorage.getItem("theme") === "dark") {
        setDarkMode(true)
        document.getElementById("dark-mode").checked = true
    } else {
        setDarkMode(false)
        document.getElementById("dark-mode").checked = false
    }

    function setDarkMode(to) {
        document.getElementById("dark-mode-style").disabled = !to
        localStorage.setItem("theme", to ? "dark" : "light")
    }

    function renderToolbar() {
        document.getElementById("toolbar").innerHTML = ""
        let legalItems = Object.entries(items).filter(([item, itemInstance]) => {return (itemInstance.task <= task && itemInstance.allowedTypes.includes(type))})
        for (const [item, itemInstance] of legalItems) {
            const toolbarItem = document.createElement("div")
            toolbarItem.className = "toolbar-item"
            toolbarItem.textContent = itemInstance.name
            toolbarItem.style.backgroundImage = "url("+itemInstance.url+")"

            toolbarItem.addEventListener("click", setActiveItem)

            if (item === activeItem) {
                const selector = document.createElement("div")
                selector.id = "selector"
                selector.style.backgroundImage = "url("+selector+")"
                toolbarItem.append(selector)
            }
            toolbar.append(toolbarItem)
        }
    }

    function renderAttributes() {
        let attributesSec = document.getElementById("attributes-section")
        attributesSec.innerHTML = ""
        let heading = document.createElement("h2")
        let description = document.createElement("p")
        heading.textContent = items[activeItem].name
        description.textContent = items[activeItem].description
        attributesSec.append(heading, description)
        let attributes = document.createElement("div")
        attributes.id = "attributes"
        items[activeItem].attributes.forEach((item) => {
            let label = document.createElement("label")
            let input = document.createElement("input")
            label.for = item.name
            label.textContent = item.name
            input.id = item.name
            input.name = item.name
            input.type = item.inputType
            input.value = item.defaultVal
            input.size = 5
            input.className = "attribute"
            attributes.append(label, input, document.createElement("br"))
        })
        attributesSec.append(attributes)
    }

    function setActiveItem(event) {
        setActiveItemTo(event.currentTarget)
    }

    function setActiveItemTo(item) {
        if (document.getElementById("selector") != null) {
            document.getElementById("selector").remove()
        }
        const selector = document.createElement("div")
        selector.id = "selector"
        selector.style.backgroundImage = "url("+selector+")"
        item.append(selector)
        activeItem = item.textContent
        renderAttributes()
    }

    function mouseDownEvent(event) {
        event.preventDefault();
        if (event.button === 0) {
            drawEvent(event)
            level.addEventListener("mouseover", drawEvent)
        } else if (event.button === 2) {
            eraseEvent(event)
            level.addEventListener("mouseover", eraseEvent)
        }
    }

    function drawEvent(event) {
        if (event.target.className === "box") {
            if (activeItem === "Player" && document.getElementById("player") != null) {
                const prev = document.getElementById("player")
                prev.id = ""
                prev.style.removeProperty("background-image")
                prev.textContent = " "
                board[Number(prev.dataset.y)][Number(prev.dataset.x)] = ""
            }

            event.target.id = activeItem === "Player" ? "player" : ""
            event.target.style.backgroundImage = "url("+items[activeItem].url+")"
            event.target.textContent = activeItem

            let attributes = document.getElementsByClassName("attribute").length !== 0 ? "," + Array.from(document.getElementsByClassName("attribute")).map((element) => element.value).reduce((a, b) => a+","+b) : ""


            board[Number(event.target.dataset.y)][Number(event.target.dataset.x)] = items[activeItem].parent+","+items[activeItem].name+","+event.target.dataset.x+","+event.target.dataset.y+attributes+"\n"
        }
        level.addEventListener("mouseup", () => {level.removeEventListener("mouseover", drawEvent)})
    }

    function eraseEvent(event) {
        if (event.target.className === "box") {
            event.target.style.removeProperty("background-image")
            event.target.textContent = " "
            board[Number(event.target.dataset.y)][Number(event.target.dataset.x)] = ""
        }
        level.addEventListener("mouseup", () => {level.removeEventListener("mouseover", eraseEvent)})
    }

    function setTile(element, url) {
        element.style.backgroundImage = url;
    }

    function resetLevel() {
        document.getElementById("level").remove()
        const nlevel = document.createElement("div")
        nlevel.id = "level"
        for (let y = 0; y < document.getElementById("height").value; y++) {
            const row = document.createElement("div")
            row.className = "row"
            for (let x = 0; x < document.getElementById("width").value; x++) {
                const tile = document.createElement("div")
                tile.className = "box"
                tile.textContent = " "
                tile.dataset.x = x.toString()
                tile.dataset.y = y.toString()
                row.append(tile)
            }
            nlevel.append(row)
        }
        nlevel.addEventListener("mousedown", mouseDownEvent)
        nlevel.addEventListener("contextmenu", (e) => {e.preventDefault()})
        document.getElementById("level-container").prepend(nlevel)
        level = nlevel
        board = Array(Number(document.getElementById("height").value)).fill("").map(() => Array(Number(document.getElementById("width").value)).fill(""))
    }

    function exportLevel() {
        let out = ""
        for (let y = 0; y < board.length; y++) {
            for (let x = 0; x < board[y].length; x++) {
                if (board[y][x].split(",")[1] === "Player") {
                    out = "PlayerStartLocation,"+x+","+y+"\n" + out
                } else {
                    out += board[y][x]
                }
            }
        }
        out = type + "\n" + out
        const link = document.createElement("a")
        const file = new Blob([out], {type: "text/plain"})
        link.href = URL.createObjectURL(file)
        link.download = document.getElementById("name").value + ".txt"
        link.click()
        URL.revokeObjectURL(link.href)
    }

</script>
</html>