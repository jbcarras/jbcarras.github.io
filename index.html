<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="static/css/editor.css">
    <link rel="stylesheet" id="dark-mode-style" href="static/css/dark.css" disabled>
    <link rel="shortcut icon" href="static/favicon.ico">
    <title>Level Editor</title>
</head>
<body>
    <div id="editor">
            <div id="level-container">
                <div id="level"></div>
            </div>
            <div id="secondary-container">
                <div id="settings">
                    <h2>Settings</h2>
                    <label for="name">Level Name</label>
                    <input id="name" name="name" type="text" oninput="{
                        const legal = /[a-z]|[0-9]|[!@#$^&()\-_+\[\]{}]/i
                        this.value = Array.from(this.value).filter((char) => {return legal.test(char)}).join('')
                    }">

                    <br/>
                    <label for="width">Width</label>
                    <input id="width" name="width" type="number" value="12" min="0" size="3" oninput="this.value = Math.max(this.value, 0)">
                    <label for="height">Height</label>
                    <input id="height" name="height" type="number" value="8" min="0" size="3" oninput="this.value = Math.max(this.value, 0)">
                    <br/>
                    <button id="export">Export</button>
                    <label for="level-import" style="display: none">Import from CSV</label>
                    <input id="level-import" name="level-import" type="file" accept="text/csv" style="display: none" onchange="importLevel(this.files[this.files.length - 1])">
                    <button onclick="document.getElementById('level-import').click()">Import</button>
                    <button id="reset">Reset</button>
                    <br/>
                    <label for="dark-mode">Dark Mode</label>
                    <input id="dark-mode" name="dark-mode" type="checkbox" onclick="setDarkMode(this.checked); document.styleSheets[0].insertRule('* {transition: background-color 0.25s linear, border 0.25s linear}')">
                </div>
                <hr/>
                <div id="attributes-section">
                    <h2>Level Editor</h2>
                    <p class="center">Click on a tile to start drawing it.</p>
                    <p class="center">Left Click - Draw</p>
                    <p class="center">Right Click - Erase</p>
                </div>
                <br/>
                <hr/>
                <div id="toolbar-container">
                    <div id="toolbar-settings">
                    <label for="task">Progress</label>
                    <select id="task" name="task">
                        <option value="1">Task 1</option>
                        <option value="2">Task 2</option>
                        <option value="3">Task 3</option>
                        <option value="4">Task 4</option>
                        <option value="5">Task 5</option>
                        <option value="6">Task 6</option>
                        <option value="7" selected>Bonus</option>
                    </select>
                    <br/>
                    <label for="type">Level Type</label>
                    <select id="type" name="type">
                        <option value="topdown" selected>TopDownLevel</option>
                        <option value="platformer">PlatformerLevel</option>
                        <option value="openworld">OpenWorldLevel</option>
                        <option value="sidescroller">SideScrollerLevel</option>
                    </select>
                </div>
                <div id="toolbar"></div>
                </div>
                <hr/>
            </div>
    </div>
</body>

<script>

    class Attribute {
        constructor(name, defaultVal, inputType) {
            this.name = name
            this.defaultVal = defaultVal
            this.inputType = inputType
        }
    }

    class Item {
        constructor(name, description, parent, attributes, url, task, allowedTypes) {
            this.name = name
            this.description = description
            this.parent = parent
            this.attributes = attributes
            this.url = "static/tiles/" + url
            this.task = task
            this.allowedTypes = allowedTypes
        }
    }

    const tools = {
        "Eraser": new Item("Eraser", "Erase tiles you previously drew.", "", [], "Eraser.png", 1, ["topdown", "platformer"]),
        "Player": new Item("Player", "Where the player appears when the level is loaded.", "", [], "Player.png", 1, ["topdown", "platformer"]),
        "Background": new Item("Background", "Set the filename for the level's background image.", "", [new Attribute("Filename", "", "text")], "BackgroundTool.png", 1, ["topdown", "platformer", "openworld", "sidescroller"])
    }

    const items = {
        "Wall": new Item("Wall", "A wall for top-down levels.", "StaticGameObject", [], "Wall.png", 1, ["topdown", "openworld"]),
        "PlatformerWall": new Item("PlatformerWall", "A wall for platformer levels. Accounts for gravity.", "StaticGameObject", [], "PlatformerWall.png", 3, ["platformer", "sidescroller"]),
        "Demon": new Item("Demon", "Harms the player. May be able to move.", "DynamicGameObject", [new Attribute("MaxHP", 10, "number"), new Attribute("Strength", 3, "number")], "Enemy.png", 1, ["topdown", "openworld"]),
        "AxePickup": new Item("AxePickup", "A slow-moving but strong projectile.", "StaticGameObject", [], "Axe.png", 5, ["topdown", "openworld"]),
        "Goal": new Item("Goal", "Calls advanceLevel() when a Player collides.", "StaticGameObject", [], "Goal.png", 1, ["topdown", "platformer", "openworld", "sidescroller"]),
        "Potion": new Item("Potion", "A potion that heals Players who come in contact.", "StaticGameObject", [new Attribute("Heal", 10, "number")], "RedPotion.png", 3, ["topdown", "platformer", "openworld", "sidescroller"]),
        "PotionPickup": new Item("PotionPickup", "A potion that gets stored in a Player's inventory to be consumed later.", "StaticGameObject", [new Attribute("Heal", 10, "number")], "BluePotion.png", 5, ["topdown", "platformer", "openworld", "sidescroller"]),
        "Tower": new Item("Tower", "Indestructible immobile enemy tower.", "DynamicGameObject", [], "Tower.png", 1, ["topdown", "openworld"]),
        "MagicPickup": new Item("MagicPickup", "A fast but weaker projectile.", "StaticGameObject", [], "Magic.png", 5, ["topdown", "openworld"]),
        "Spike": new Item("Spike", "A fatal obstacle.", "StaticGameObject", [], "Spike.png", 3, ["topdown", "platformer", "openworld", "sidescroller"]),
        "SmartEnemy": new Item("SmartEnemy", "A smarter enemy that hunts the player down, avoiding walls.", "DynamicGameObject", [new Attribute("MaxHP", 10, "number"), new Attribute("Strength", 1, "number")], "SmartEnemy.png", 6, ["topdown", "openworld"]),
        "Archer": new Item("Archer", "An enemy who fires harmful arrows at the player.", "DynamicGameObject", [new Attribute("MaxHP", 10, "number"), new Attribute("Strength", 1, "number")], "Archer.png", 7, ["topdown", "openworld"]),
        "PushWall": new Item("PushWall", "A wall that gets pushed when collided with.", "DynamicGameObject", [], "PushWall.png", 7, ["topdown", "openworld"]),
        "Platform": new Item("Platform", "A platform that can be jumped through.", "StaticGameObject", [], "Platform.png", 7, ["platformer", "sidescroller"]),
        "Ledge": new Item("Ledge", "A barrier that can be walked through from above, but not below.", "StaticGameObject", [], "Ledge.png", 7, ["topdown", "openworld"]),
        "InfoNode": new Item("InfoNode", "An interactable object that displays text.", "StaticGameObject", [new Attribute("Text", "", "text")], "InfoNode.png", 7, ["topdown", "openworld", "sidescroller", "platformer"]),
        "Horse": new Item("Horse", "Immovable horse of destruction.", "StaticGameObject", [], "Horse.png", 7, ["topdown", "openworld"])
    }

    const toolbarLookup = {...tools, ...items}

    const selector = "static/tiles/Selector.png"

    let board = []

    let activeItem = ""
    let task = 7
    let type = "topdown"

    let toolbar = document.getElementById("toolbar")
    let level = document.getElementById("level")

    const reset = document.getElementById("reset")
    reset.addEventListener("click", resetLevel)

    const exportBtn = document.getElementById("export")
    exportBtn.addEventListener("click", exportLevel)

    const taskSelect = document.getElementById("task")
    taskSelect.addEventListener("change", () => {
        task = Number(taskSelect.value)
        if (activeItem === "" || toolbarLookup[activeItem].task > task) {
            activeItem = ""
        }
        renderToolbar()
        renderAttributes()
    })

    const typeSelect = document.getElementById("type")
    typeSelect.addEventListener("change", () => {
        type = typeSelect.value
        renderToolbar()
        if (activeItem === "" || !toolbarLookup[activeItem].allowedTypes.includes(type)) {
            activeItem = ""
        }
        renderAttributes()
    })

    let backgroundFname = "Grass.png"

    type = typeSelect.value
    task = Number(taskSelect.value)

    resetLevel()
    renderToolbar()

    if (localStorage.getItem("theme") === "dark") {
        setDarkMode(true)
        document.getElementById("dark-mode").checked = true
    } else {
        setDarkMode(false)
        document.getElementById("dark-mode").checked = false
    }

    function setDarkMode(to) {
        document.getElementById("dark-mode-style").disabled = !to
        localStorage.setItem("theme", to ? "dark" : "light")
    }

    function renderToolbar() {
        document.getElementById("toolbar").innerHTML = ""
        for (const [item, itemInstance] of Object.entries(tools)) {
            const toolbarItem = document.createElement("div")
            toolbarItem.className = "toolbar-item"
            toolbarItem.textContent = itemInstance.name
            toolbarItem.style.backgroundImage = "url("+itemInstance.url+")"

            toolbarItem.addEventListener("click", setActiveItem)

            if (item === activeItem) {
                const selector = document.createElement("div")
                selector.id = "selector"
                selector.style.backgroundImage = "url("+selector+")"
                toolbarItem.append(selector)
            }
            toolbar.append(toolbarItem)
        }
        toolbar.append(document.createElement("hr"))

        let legalItems = Object.entries(items).filter(([item, itemInstance]) => {return (itemInstance.task <= task && itemInstance.allowedTypes.includes(type) && !Object.keys(tools).includes(item))})
        for (const [item, itemInstance] of legalItems) {
            const toolbarItem = document.createElement("div")
            toolbarItem.className = "toolbar-item"
            toolbarItem.textContent = itemInstance.name
            toolbarItem.style.backgroundImage = "url("+itemInstance.url+")"

            toolbarItem.addEventListener("click", setActiveItem)

            if (item === activeItem) {
                const selector = document.createElement("div")
                selector.id = "selector"
                selector.style.backgroundImage = "url("+selector+")"
                toolbarItem.append(selector)
            }
            toolbar.append(toolbarItem)
        }
    }

    function importLevel(file) {
        const reader = new FileReader()
        reader.readAsText(file)
        reader.onload = () => {
            const lvl = reader.result.split("\n")
            switch (lvl[0].split(',')[0]) {
                case "TopDownLevel":
                    typeSelect.value = "topdown"
                    break
                case "PlatformerLevel":
                    typeSelect.value = "platformer"
                    break
                case "OpenWorldLevel":
                    typeSelect.value = "openworld"
                    break
                case "SideScrollerLevel":
                    typeSelect.value = "sidescroller"
                    break
                default:
                    return
            }
            document.getElementById("name").value = lvl[0].split(',')[1]
            document.getElementById("width").value = lvl[0].split(',')[2]
            document.getElementById("height").value = lvl[0].split(',')[3]
            resetLevel()
            let width = lvl[1].split(',')[1]
            let height = lvl[1].split(',')[2]
            board[height][width] = `,Player,${width},${height}`
            for (let line of lvl.slice(2)) {
                if (line !== "") {
                    let width = line.split(',')[2]
                    let height = line.split(',')[3]
                    board[height][width] = line + "\n"
                }
            }
            for (let y = 0; y < board.length; y++) {
                for (let x = 0; x < board[y].length; x++) {
                    if (board[y][x] !== "") {
                        const div = document.getElementById("level").children[y].children[x]
                        div.style.backgroundImage = `url(${toolbarLookup[board[y][x].split(',')[1]].url})`
                        div.textContent = board[y][x].split(',')[1]
                    }
                }
            }
        }
    }

    function renderAttributes() {
        if (!Object.keys(toolbarLookup).includes(activeItem)) {
            document.getElementById("attributes-section").innerHTML = "<h2>Level Editor</h2><p class=\"center\">Click on a tile to start drawing it.</p><p class=\"center\">Left Click - Draw</p> <p class=\"center\">Right Click - Erase</p>"
            return
        }
        let attributesSec = document.getElementById("attributes-section")
        attributesSec.innerHTML = ""
        let heading = document.createElement("h2")
        let description = document.createElement("p")
        let attributes = document.createElement("div")
        attributes.id = "attributes"
        heading.textContent = toolbarLookup[activeItem].name
        description.textContent = toolbarLookup[activeItem].description
        attributesSec.append(heading, description)
        toolbarLookup[activeItem].attributes.forEach((item) => {
            let label = document.createElement("label")
            let input = document.createElement("input")
            label.for = item.name
            label.textContent = item.name
            input.id = item.name
            input.name = item.name
            input.type = item.inputType
            input.value = item.defaultVal
            const legal = /[a-z]|[0-9]|[!@#$%^&*()\-_+=.?~`]/i;
            input.oninput = (item) => {item.target.value = Array.from(item.target.value).filter((character) => {return legal.test(character)}).join('')}
            if (item.inputType !== "text") {
                input.size = 5
            }
            if (item.name === "Filename") {
                input.value = backgroundFname
                input.addEventListener("change", (event) => {backgroundFname = event.target.value})
            }
            input.className = "attribute"
            attributes.append(label, input, document.createElement("br"))
        })
        attributesSec.append(attributes)
    }

    function setActiveItem(event) {
        setActiveItemTo(event.currentTarget)
    }

    function setActiveItemTo(item) {
        if (document.getElementById("selector") != null) {
            document.getElementById("selector").remove()
        }
        const selector = document.createElement("div")
        selector.id = "selector"
        selector.style.backgroundImage = "url("+selector+")"
        item.append(selector)
        activeItem = item.textContent
        renderAttributes()
    }

    function mouseDownEvent(event) {
        event.preventDefault();
        if (activeItem === "") {
            return
        }
        let option = activeItem === "Eraser" ? 2 : event.button
        if (option === 0) {
            drawEvent(event)
            level.addEventListener("mouseover", drawEvent)
        } else if (option === 2) {
            eraseEvent(event)
            level.addEventListener("mouseover", eraseEvent)
        }
    }

    function drawEvent(event) {
        if (event.target.className === "box") {
            if (activeItem === "Player" && document.getElementById("player") != null) {
                const prev = document.getElementById("player")
                prev.id = ""
                prev.style.removeProperty("background-image")
                prev.textContent = " "
                board[Number(prev.dataset.y)][Number(prev.dataset.x)] = ""
            }

            event.target.id = activeItem === "Player" ? "player" : ""
            event.target.style.backgroundImage = "url("+toolbarLookup[activeItem].url+")"
            event.target.textContent = activeItem

            let attributes = document.getElementsByClassName("attribute").length !== 0 ? "," + Array.from(document.getElementsByClassName("attribute")).map((element) => element.value).reduce((a, b) => a+","+b) : ""


            board[Number(event.target.dataset.y)][Number(event.target.dataset.x)] = toolbarLookup[activeItem].parent+","+toolbarLookup[activeItem].name+","+event.target.dataset.x+","+event.target.dataset.y+attributes+"\n"
        }
        level.addEventListener("mouseup", () => {level.removeEventListener("mouseover", drawEvent)})
    }

    function eraseEvent(event) {
        if (event.target.className === "box") {
            event.target.style.removeProperty("background-image")
            event.target.textContent = " "
            board[Number(event.target.dataset.y)][Number(event.target.dataset.x)] = ""
        }
        level.addEventListener("mouseup", () => {level.removeEventListener("mouseover", eraseEvent)})
    }

    function setTile(element, url) {
        element.style.backgroundImage = url;
    }

    function resetLevel() {
        document.getElementById("level").remove()
        const nlevel = document.createElement("div")
        nlevel.id = "level"
        for (let y = 0; y < document.getElementById("height").value; y++) {
            const row = document.createElement("div")
            row.className = "row"
            for (let x = 0; x < document.getElementById("width").value; x++) {
                const tile = document.createElement("div")
                tile.className = "box"
                tile.textContent = " "
                tile.dataset.x = x.toString()
                tile.dataset.y = y.toString()
                row.append(tile)
            }
            nlevel.append(row)
        }
        nlevel.addEventListener("mousedown", mouseDownEvent)
        nlevel.addEventListener("contextmenu", (e) => {e.preventDefault()})
        document.getElementById("level-container").prepend(nlevel)
        level = nlevel
        board = Array(Number(document.getElementById("height").value)).fill("").map(() => Array(Number(document.getElementById("width").value)).fill(""))
    }

    function exportLevel() {
        let name = document.getElementById("name").value === "" ? "level" : document.getElementById("name").value
        let out = ""
        let startLocation = []
        for (let y = 0; y < board.length; y++) {
            for (let x = 0; x < board[y].length; x++) {
                if (board[y][x].split(",")[1] === "Player") {
                    startLocation = [x, y]
                } else {
                    out += board[y][x]
                }
            }
        }
        let typePrettyName = ""
        switch (type) {
            case "topdown":
                typePrettyName = "TopDownLevel"
                break
            case "platformer":
                typePrettyName = "PlatformerLevel"
                break
            case "openworld":
                typePrettyName = "OpenWorldLevel"
                break
            case "sidescroller":
                typePrettyName = "SideScrollerLevel"
                break
            default:
                typePrettyName = type
        }

        out = `${typePrettyName},${name},${board[0].length},${board.length}\nPlayerStartLocation,${startLocation[0]},${startLocation[1]}\nBackgroundImage,${backgroundFname}\n` + out
        const link = document.createElement("a")
        const file = new Blob([out], {type: "text/plain"})
        link.href = URL.createObjectURL(file)
        link.download = name + ".csv"
        link.click()
        URL.revokeObjectURL(link.href)
    }

</script>
</html>